#!/bin/bash

##
# Note(Pluvie): this script works with two preconditions:
# 1. A `ion` symbolic link in the main folder which points to ⚡️ION⚡️ source dir.
# 2. `cc1` and `inflect` scripts in the `bin` folder as provided by the ⚡️ION⚡️ library.
##

if [[ $# -lt 1 ]]; then
  echo "Usage: bin/net APP COMMAND"
  exit 1
fi

PLATFORM="LINUX"
ARCHITECTURE="X64"
DEFAULT_FLAGS="-std=c11 -Wall -Werror"

if [[ $1 == "spec" ]]; then
  SPECS=$(find app/spec/specs/ -name "*.c" -type f | tr '\n' ' ')
  FILES="app/spec/main.c app/spec/containers.c $SPECS"

  if [[ $2 == "prep" ]]; then
    mkdir -p tmp
    gcc $FILES                      \
      $DEFAULT_FLAGS                \
      -D PLATFORM=$PLATFORM         \
      -D ARCHITECTURE=$ARCHITECTURE \
      -I ./src                      \
      -I ./ion                      \
      -E | bin/inflect > tmp/spec.c

    exit $?
  fi

  mkdir -p exe
  gcc $FILES                        \
    -no-integrated-cpp -B ./bin     \
    $DEFAULT_FLAGS                  \
    -D PLATFORM=$PLATFORM           \
    -D ARCHITECTURE=$ARCHITECTURE   \
    -I ./src                        \
    -I ./ion                        \
    -g3 -o exe/spec

  if [ $? -ne 0 ]; then
    exit 1
  fi

  if [[ $2 == "run" ]]; then
    valgrind                        \
      --track-origins=yes           \
      --leak-check=full             \
      --show-leak-kinds=all         \
      exe/spec
    echo

  elif [[ $2 == "debug" ]]; then
    gdb exe/spec

  else
    echo "Usage: bin/net spec [run|prep|debug]"
    exit 1
  fi

elif [[ $1 == "http_sample" ]]; then
  FILES="app/http_sample/main.c"

  if [[ $2 == "debug" ]]; then
    mkdir -p exe
    gcc $FILES                      \
      -no-integrated-cpp -B ./bin   \
      $DEFAULT_FLAGS                \
      -D PLATFORM=$PLATFORM         \
      -D ARCHITECTURE=$ARCHITECTURE \
      -I ./src                      \
      -I ./ion                      \
      -g3 -o exe/http_sample

    if [ $? -ne 0 ]; then
      exit 1
    fi

    valgrind                        \
      --track-origins=yes           \
      --leak-check=full             \
      --show-leak-kinds=all         \
      exe/http_sample
    echo

    exit $?
  fi

  mkdir -p exe
  gcc $FILES                        \
    -no-integrated-cpp -B ./bin     \
    $DEFAULT_FLAGS                  \
    -D PLATFORM=$PLATFORM           \
    -D ARCHITECTURE=$ARCHITECTURE   \
    -I ./src                        \
    -I ./ion                        \
    -O3 -march=native               \
    -o exe/http_sample

  if [ $? -ne 0 ]; then
    exit 1
  fi

  if [[ $2 == "run" ]]; then
    exe/http_sample

  else
    echo "Usage: bin/net http_sample [debug|run]"
    exit 1
  fi


elif [[ $1 == "lib" ]]; then

  mkdir -p exe
  gcc $ION/net.c                    \
    $DEFAULT_FLAGS                  \
    -D PLATFORM=$PLATFORM           \
    -D ARCHITECTURE=$ARCHITECTURE   \
    -o exe/libnet.so                \
    -I ./ion                        \
    -I ./src                        \
    -O3 -march=native               \
    -shared -fPIC

  exit $?
fi
